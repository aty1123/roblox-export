<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background-color: #0e0e0e;
      color: #f0f0f0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: #1a1a1a;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 0 30px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 1100px;
    }
    h1 {
      text-align: center;
      color: #ffffff;
      margin-bottom: 24px;
    }
    input, select {
      padding: 12px;
      font-size: 16px;
      border: 1px solid #333;
      border-radius: 6px;
      background-color: #2a2a2a;
      color: #f0f0f0;
    }
    button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #666;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 24px;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #333;
      text-align: center;
    }
    th {
      background-color: #111;
      cursor: pointer;
    }
    tr:hover {
      background-color: #1e1e1e;
    }
    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 16px;
    }
    .action-bar .group {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    canvas {
      background-color: #1a1a1a;
      border-radius: 8px;
      padding: 16px;
      margin-top: 32px;
      width: 100% !important;
      max-height: 400px;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      font-size: 14px;
      color: #ccc;
    }
    .pagination button {
      min-width: 100px;
    }
    @media screen and (max-width: 768px) {
      th, td {
        font-size: 14px;
      }
      .action-bar .group {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="main" style="text-align: center; max-width: 400px; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh;">
    <h1>Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏</h1>
    <input type="password" id="pw" placeholder="Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" style="margin-bottom:12px; width:100%"/>
    <button onclick="login()" style="width:100%">Î°úÍ∑∏Ïù∏</button>
  </div>
  <script>
    let allData = {}, currentPage = 1, perPage = 10, sortCol = 0, sortAsc = true, currentMetric = 'playtime';

    function login(refresh = false) {
      const pw = refresh ? window.currentPw : document.getElementById('pw').value;
      if (!pw) return;
      window.currentPw = pw;

      fetch('/admin/data', { headers: { Authorization: `Bearer ${pw}` } })
        .then(res => res.json())
        .then(data => {
          allData = data;
          document.getElementById('main').style = '';
          document.getElementById('main').innerHTML = `
            <h1>Roblox Ïú†Ï†Ä Î™©Î°ù</h1>
            <div class="action-bar">
              <div class="group">
                <input id="search" placeholder="User ID ÎòêÎäî Username Í≤ÄÏÉâ" style="flex:2" />
                <select id="perPage" onchange="perPage = +this.value; currentPage=1; renderRows();">
                  <option value="10">10Í∞úÏî© Î≥¥Í∏∞</option>
                  <option value="25">25Í∞úÏî© Î≥¥Í∏∞</option>
                  <option value="50">50Í∞úÏî© Î≥¥Í∏∞</option>
                </select>
                <button onclick="login(true)">üîÅ ÏÉàÎ°úÍ≥†Ïπ®</button>
              </div>
              <div class="group">
                <label>Í∑∏ÎûòÌîÑ:</label>
                <select id="metric" onchange="currentMetric=this.value; drawChart();">
                  <option value="playtime">Playtime</option>
                  <option value="money">Money</option>
                </select>
                <select id="percent" onchange="drawChart()">
                  <option value="1">ÏÉÅÏúÑ 1%</option>
                  <option value="5">ÏÉÅÏúÑ 5%</option>
                  <option value="10" selected>ÏÉÅÏúÑ 10%</option>
                  <option value="25">ÏÉÅÏúÑ 25%</option>
                </select>
              </div>
            </div>
            <table>
              <thead>
                <tr>
                  <th onclick="sortBy(0)">User ID</th>
                  <th onclick="sortBy(1)">Money</th>
                  <th onclick="sortBy(2)">Playtime</th>
                  <th onclick="sortBy(3)">Username</th>
                  <th onclick="sortBy(4)">Updated</th>
                </tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
            <div class="pagination">
              <button onclick="changePage(-1)">‚¨Ö Ïù¥Ï†Ñ</button>
              <span id="page"></span>
              <button onclick="changePage(1)">Îã§Ïùå ‚û°</button>
            </div>
            <canvas id="chart"></canvas>
          `;
          document.getElementById('search').addEventListener('input', () => {
            currentPage = 1;
            renderRows();
          });
          renderRows();
          drawChart();
        })
        .catch(() => alert('‚ùå Ïù∏Ï¶ù Ïã§Ìå®'));
    }

    function renderRows() {
      const search = document.getElementById('search').value.toLowerCase();
      const rows = document.getElementById('rows');
      let entries = Object.entries(allData).map(([id, u]) => ({ id, ...u }));
      if (search) entries = entries.filter(u => u.id.includes(search) || (u.username ?? '').toLowerCase().includes(search));

      entries.sort((a, b) => {
        const cols = ['id', 'money', 'playtime', 'username', 'updatedAt'];
        const key = cols[sortCol];
        return (a[key] > b[key] ? 1 : -1) * (sortAsc ? 1 : -1);
      });

      const totalPages = Math.ceil(entries.length / perPage);
      const start = (currentPage - 1) * perPage;
      const pageData = entries.slice(start, start + perPage);

      rows.innerHTML = pageData.map(u => `
        <tr>
          <td>${u.id}</td>
          <td>${u.money ?? 0}</td>
          <td>${u.playtime ?? 0}</td>
          <td>${u.username ?? 'Unknown'}</td>
          <td>${new Date(u.updatedAt).toLocaleString()}</td>
        </tr>
      `).join('');
      document.getElementById('page').textContent = `${currentPage} / ${totalPages}`;
    }

    function changePage(d) {
      currentPage += d;
      renderRows();
    }

    function sortBy(n) {
      sortAsc = sortCol === n ? !sortAsc : true;
      sortCol = n;
      renderRows();
    }

    function drawChart() {
      const metric = currentMetric;
      const topPercent = +document.getElementById('percent').value;
      const filtered = Object.entries(allData)
        .filter(([_, u]) => (u[metric] ?? 0) > 0)
        .map(([id, u]) => ({ label: u.username ?? id, value: u[metric] ?? 0 }));
      filtered.sort((a, b) => b.value - a.value);
      const top = filtered.slice(0, Math.ceil(filtered.length * (topPercent / 100)));

      const ctx = document.getElementById('chart').getContext('2d');
      if (window.chart) window.chart.destroy();
      window.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: top.map(x => x.label),
          datasets: [{ label: metric.toUpperCase(), data: top.map(x => x.value), backgroundColor: '#90caf9' }]
        },
        options: {
          responsive: true,
          plugins: { legend: { labels: { color: '#fff' } } },
          scales: {
            x: { ticks: { color: '#fff' } },
            y: { ticks: { color: '#fff' } }
          }
        }
      });
    }
  </script>
</body>
</html>
